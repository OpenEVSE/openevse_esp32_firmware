name: Unit Tests

on:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master, develop ]

jobs:
  native-tests:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
        
    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        
    - name: Cache PlatformIO packages
      uses: actions/cache@v3
      with:
        path: ~/.platformio
        key: ${{ runner.os }}-platformio-${{ hashFiles('**/platformio.ini') }}
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
        
    - name: Install PlatformIO
      run: |
        python -m pip install --upgrade pip
        pip install platformio
        
    - name: Install GUI dependencies
      run: |
        cd gui-v2
        npm install
        npm run build
        
    - name: Install project dependencies
      run: pio lib install
      
    - name: Run native unit tests
      run: pio test -e native_test
      
    - name: Upload test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: native-test-results
        path: .pio/test/
        
  esp32-build-test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
        
    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        
    - name: Cache PlatformIO packages
      uses: actions/cache@v3
      with:
        path: ~/.platformio
        key: ${{ runner.os }}-platformio-${{ hashFiles('**/platformio.ini') }}
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
        
    - name: Install PlatformIO
      run: |
        python -m pip install --upgrade pip
        pip install platformio
        
    - name: Install GUI dependencies
      run: |
        cd gui-v2
        npm install
        npm run build
        
    - name: Install project dependencies
      run: pio lib install
      
    - name: Build test firmware for ESP32
      run: pio run -e test_esp32dev
      
    - name: Build test firmware for OpenEVSE WiFi v1
      run: pio run -e test_openevse_wifi_v1
      
    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: esp32-test-firmware
        path: .pio/build/*/firmware.bin
        
  python-tests:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
        
    - name: Install Python dependencies
      run: |
        cd divert_sim
        pip install -r requirements.txt
        
    - name: Run Python divert simulation tests
      run: |
        cd divert_sim
        pytest -v
        
    - name: Upload Python test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: python-test-results
        path: divert_sim/